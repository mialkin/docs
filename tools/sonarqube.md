# SonarQube

[↑ SonarQube](https://www.sonarsource.com/products/sonarqube/) is an open source platform to perform automatic reviews with _static analysis_ of code to detect bugs, code smells and security vulnerabilities on 25+ programming languages.

A **static analysis** is a type of analysis that does not rely on actually running the code: analysis of running code is called **dynamic analysis**.

SonarQube also highlights the complex areas of code that are less covered by unit tests.

## Table of contents

- [SonarQube](#sonarqube)
  - [Table of contents](#table-of-contents)
  - [Installation](#installation)
  - [SonarScanner](#sonarscanner)
    - [SonarScanner usage](#sonarscanner-usage)
      - [Begin step](#begin-step)
      - [Build step](#build-step)
      - [End step](#end-step)
    - [Executing steps](#executing-steps)
  - [SonarLint](#sonarlint)
  - [Workflow](#workflow)
  - ["Clean as you code" approach](#clean-as-you-code-approach)
  - [Quality gate](#quality-gate)
    - [Recommended quality gate](#recommended-quality-gate)
    - [Getting notified when a quality gate fails](#getting-notified-when-a-quality-gate-fails)
  - [Pull request analysis](#pull-request-analysis)
  - [SonarCloud](#sonarcloud)

## Installation

```bash
services:
  sonarqube:
    image: sonarqube:community
    #    command: -Dsonar.ce.javaOpts=-Xmx1192m -Dsonar.web.javaOpts=-Xmx1192m
    restart: unless-stopped
    container_name: sonarqube
    depends_on:
      - sonarqube-postgres
    ports:
      - "9000:9000"
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonarqube-postgres:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs

  sonarqube-postgres:
    image: postgres:17.6
    container_name: sonarqube-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
    volumes:
      - postgresql:/var/lib/postgresql
      - postgres_data:/var/lib/postgresql/data

volumes:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql:
  postgres_data:
```

[↑ Installing SonarQube Community Build from the Docker image](https://docs.sonarsource.com/sonarqube-community-build/server-installation/from-docker-image/basic-installation/).

## SonarScanner

Once the SonarQube platform has been installed, to enable CI-based analysis you have to install and configure a piece of software called a _scanner_.

Typically, the scanner is configured to run as part of your continuous integration pipeline so that whenever your build process is triggered, the scanner is invoked and performs a scan on the code.

[↑ SonarScanner for .NET](https://docs.sonarsource.com/sonarqube-server/latest/analyzing-source-code/scanners/dotnet/installing/).

Install [↑ dotnet-sonarscanner](https://www.nuget.org/packages/dotnet-sonarscanner) dotnet tool:

```bash
dotnet tool install --global dotnet-sonarscanner
```

### SonarScanner usage

#### Begin step

The begin step is executed when you add the `begin` command line argument. It hooks into the build pipeline, downloads SonarQube quality profiles and settings and prepares your project for the analysis.

#### Build step

Between the begin and end steps, you need to build your project, execute tests and generate code coverage data. This part is specific to your needs and it is not detailed here.

#### End step

The end step is executed when you add the `end` command line argument. It cleans the build hooks, collects the analysis data generated by the build, the test results, the code coverage and then uploads everything to SonarQube

### Executing steps

```bash
dotnet sonarscanner begin -k:"SONARQUBE_PROJECT_KEY" -d:sonar.login="AUTHENTICATION_TOKEN_OR_USERNAME"
dotnet build PATH_TO_SOLUTION_FILE
dotnet sonarscanner end -d:sonar.login="AUTHENTICATION_TOKEN_OR_USERNAME"
```

## SonarLint

[↑ SonarLint](https://www.sonarsource.com/products/sonarlint/) is a free IDE extension to find and fix bugs, vulnerabilities and code smells.

## Workflow

1. Developers code in their IDEs and, potentially, use SonarLint to run local analysis.
2. Developers push their code into Git repository.
3. The CI server triggers an automatic build and the execution of the SonarScanner required to run the SonarQube analysis.
4. The analysis report is sent to the SonarQube server for processing.
5. SonarQube server processes and stores the analysis report results in the SonarQube database, and displays the results in the UI.
6. Developers review, comment, challenge their issues to manage and reduce their technical debt through the SonarQube UI.
7. Managers receive reports from the analysis. Ops use APIs to automate configuration and extract data from SonarQube.

## "Clean as you code" approach

While SonarCloud does provide an overall picture of the quality of your entire codebase, it focuses on highlighting issues found on incoming changes as they arrive. This strategy is tied to a principle of coding referred to as "clean as you code". The idea behind this principle is that the efforts of a software development team in remediating code issues should always be focussed on preventing issues in incoming new code and fixing issues in the areas where those new changes occur, as opposed to digging through old code for the sole purpose of finding issues. In most software projects the natural progress of change will eventually touch the entire codebase, so remediation will even encompass the entire body of the code in any case.

## Quality gate

A **quality gate** is a set of conditions that tells you whether or not your project is ready for release. With the clean as you code approach, your Quality Gate should:

- **Focus on new code metrics**: new features will be delivered cleanly. As long as your quality gate is green, your releases will continue to improve.
- **Set and enforce high standards**: you aren't worried about having to meet those standards in old code and having to clean up someone else's code. You can take pride in meeting high standards of _your_ code. If a project doesn't meet these high standards, it won't pass the quality gate, and it's obviously not ready to be released.

### Recommended quality gate

We recommend the built-in `Sonar way` quality gate for most projects. It focuses on keeping new code clean, rather than spending a lot of effort remediating old code. Out of the box, it's already set as the default profile.

[↑ Quality Gates](https://docs.sonarsource.com/sonarqube-server/latest/quality-standards-administration/managing-quality-gates/introduction-to-quality-gates/).

### Getting notified when a quality gate fails

Thanks to the notification mechanism, users can be notified when a quality gate fails. To do so, subscribe to the New quality gate status notification either for all projects or a set of projects you're interested in.

## Pull request analysis

You can use pull request analysis and decoration to make sure your code is meeting your standards before you merge. Pull request analysis lets you see your pull request's quality gate in the SonarQube UI.

[↑ Pull Request Analysis](https://docs.sonarsource.com/sonarqube-server/latest/analyzing-source-code/pull-request-analysis/introduction/).

## SonarCloud

[↑ SonarCloud](https://sonarcloud.io) is a cloud-based code analysis service designed to detect code quality issues in 25 different programming languages, continuously ensuring the maintainability, reliability and security of your code.

Unlike self-hosted SonarQube, SonarCloud is hosted by [↑ SonarSource](https://www.sonarsource.com) in AWS and is the easiest path to start scanning your code in minutes. SonarSource does all the heavy lifting for you, so you don't have to worry about installation or maintenance. As a SaaS offering, SonarCloud gives you immediate access to new features and functionality.

> In summary, if your team is fully cloud-based, you don't want maintenance hassles and you'd like the fastest access to new features, then SonarCloud is a great choice. If you're fine with self-hosting and maintenance or see value in the management capabilities, then SonarQube would make sense for you.

[↑ SonarQube Cloud or SonarQube Server, What's Right for Your Team?](https://www.sonarsource.com/blog/sq-sc_guidance/).
